<!DOCTYPE html>
<html lang="de" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GiroCode + Rechnungs‚ÄëPDF ‚Äî Pro</title>
  <meta name="description" content="Erstelle einen EPC/GiroCode (SEPA‚ÄëQR) und eine Rechnungs‚ÄëPDF mit Positionstabelle ‚Äî alles lokal im Browser." />
  <style>
    :root{
      --bg:#0b0c10; --card:#121318; --text:#e8eaf0; --muted:#98a1b3; --line:#1f2431; --input:#0f1117; --accent:#22c55e; --accent2:#16a34a;
      --btn:#0f172a; --shadow:0 10px 24px rgba(0,0,0,.25);
    }
    :root[data-theme="light"]{
      --bg:#f7f8fb; --card:#ffffff; --text:#0f1221; --muted:#435067; --line:#e6e9f2; --input:#f2f4f9; --accent:#0ea5e9; --accent2:#22c55e; --btn:#eef2ff; --shadow:0 8px 18px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    h1{font-size:28px;margin:0 0 8px}
    p{margin:0;color:var(--muted)}
    .toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:10px}
    .kicker{display:inline-flex;gap:8px;align-items:center;padding:4px 10px;border-radius:999px;background:#133018;color:#86efac;font-size:12px}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;margin-top:18px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:var(--shadow)}
    label{display:block;font-size:13px;margin:10px 0 6px;color:var(--muted)}
    input,textarea{width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);background:var(--input);color:var(--text)}
    textarea{resize:vertical}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .btn{cursor:pointer;padding:12px 16px;border-radius:12px;border:1px solid var(--line);background:var(--btn);color:var(--text);transition:.18s ease}
    .btn:hover{transform:translateY(-1px);box-shadow:var(--shadow)}
    .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));border:none;font-weight:700;color:#fff}
    .muted{font-size:12px;color:var(--muted)}
    .qrbox{display:flex;align-items:center;justify-content:center;min-height:220px;border:1px dashed var(--line);border-radius:12px;background:var(--input)}
    .ok{color:#16a34a}.err{color:#ef4444}
    .toggle{padding:10px 12px;border-radius:10px;background:var(--input);border:1px solid var(--line);cursor:pointer}

    table.items{width:100%;border-collapse:separate;border-spacing:0 8px;margin-top:10px}
    table.items th{font-size:12px;text-transform:uppercase;letter-spacing:.04em;color:var(--muted);text-align:left;padding:0 8px}
    table.items td{background:var(--input);border:1px solid var(--line);padding:6px;border-radius:10px}
    table.items input{background:transparent;border:none;padding:8px;width:100%;color:var(--text)}
    .t-right{text-align:right}
    .sum{display:grid;grid-template-columns:1fr auto;gap:8px;margin-top:12px}
    .sum div{padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:var(--input)}
    .sum .num{font-variant-numeric:tabular-nums;text-align:right}
    .footer{margin-top:20px;font-size:12px;color:var(--muted)}
    @media (max-width:960px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="toolbar">
      <div class="kicker">Lokal ¬∑ keine Uploads</div>
      <button id="themeBtn" class="toggle" title="Theme umschalten">üåô Dark</button>
    </div>
    <h1>GiroCode & Rechnungs‚ÄëPDF</h1>
    <p>Erzeuge einen <strong>EPC/GiroCode</strong> und eine <strong>PDF‚ÄëRechnung</strong> mit Positionen.</p>

    <div class="grid">
      <div class="card">
        <h3 style="margin:0 0 8px">Zahlungsdaten</h3>
        <label>Empf√§nger (Name)</label>
        <input id="name" placeholder="z.‚ÄØB. Max Mustermann e.‚ÄØK." />
        <div class="two">
          <div>
            <label>IBAN</label>
            <input id="iban" placeholder="DE89 3704 0044 0532 0130 00" />
          </div>
          <div>
            <label>BIC (optional)</label>
            <input id="bic" placeholder="z.‚ÄØB. COLSDE33" />
          </div>
        </div>
        <div class="two">
          <div>
            <label>Verwendungszweck</label>
            <input id="purpose" maxlength="140" placeholder="Rechnung 2025‚Äë0001" />
          </div>
          <div>
            <label>Betrag (‚Ç¨) <span class="muted">(optional, wird aus Positionen √ºbernommen)</span></label>
            <input id="amount" type="number" step="0.01" placeholder="199.00" />
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn primary" onclick="makeQR()">GiroCode generieren</button>
          <button class="btn" onclick="clearQR()">Zur√ºcksetzen</button>
        </div>
        <div id="qrStatus" class="muted" style="margin-top:8px"></div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px">Vorschau (QR)</h3>
        <div class="qrbox"><canvas id="qrCanvas" width="220" height="220"></canvas></div>
        <div class="muted" style="margin-top:8px">Tipp: Banking‚ÄëApp √∂ffnen & Code testen.</div>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 style="margin:0">Positionen</h3>
        <div class="row" style="gap:8px">
          <label style="display:flex;align-items:center;gap:6px"><input id="autoAmount" type="checkbox" checked> <span class="muted">Betrag automatisch in Zahlungsdaten √ºbernehmen</span></label>
          <button class="btn" onclick="addItem()">+ Position</button>
        </div>
      </div>

      <table class="items" id="itemsTable">
        <thead>
          <tr>
            <th style="width:44px">Pos</th>
            <th>Beschreibung</th>
            <th style="width:90px">Menge</th>
            <th style="width:120px">Preis (‚Ç¨)</th>
            <th style="width:120px" class="t-right">Zwischensumme</th>
            <th style="width:60px"></th>
          </tr>
        </thead>
        <tbody id="itemsBody"></tbody>
      </table>

      <div class="two" style="margin-top:8px">
        <div>
          <label>Steuersatz (%)</label>
          <input id="vatRate" type="number" step="1" value="19">
        </div>
        <div></div>
      </div>

      <div class="sum">
        <div>Summe netto</div><div class="num" id="sumNet">0,00 ‚Ç¨</div>
        <div>USt.</div><div class="num" id="sumVat">0,00 ‚Ç¨</div>
        <div style="font-weight:700">Gesamt (brutto)</div><div class="num" id="sumGross">0,00 ‚Ç¨</div>
      </div>
    </div>

    <div class="row" style="margin-top:16px">
      <button class="btn primary" onclick="downloadPDF()">PDF herunterladen</button>
    </div>

    <div class="footer">¬© <span id="y"></span> ¬∑ lokal ¬∑ keine Gew√§hr.</div>
  </div>

  <!-- Lib‚ÄëLoader: versucht lokal (/vendor), dann alternative CDNs -->
  <script>
    (function(){
      function loadScript(src){return new Promise(function(res,rej){var s=document.createElement('script');s.src=src;s.async=true;s.onload=res;s.onerror=function(){rej(new Error('Failed '+src))};document.head.appendChild(s);});}
      window.__libsReady=(async function(){
        var okQR=false, okPDF=false;
        try{await loadScript('/vendor/qrcode.min.js'); okQR=!!window.QRCode;}catch(e){}
        if(!okQR){try{await loadScript('https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js'); okQR=!!window.QRCode;}catch(e){}}
        if(!okQR){try{await loadScript('https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js'); okQR=!!window.QRCode;}catch(e){}}
        try{await loadScript('https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js'); okPDF=!!window.PDFLib;}catch(e){}
        if(!okPDF){try{await loadScript('/vendor/pdf-lib.min.js'); okPDF=!!window.PDFLib;}catch(e){}}
        if(!okQR||!okPDF) console.warn('Lib load status',{okQR,okPDF});
        return {okQR,okPDF};
      })();
    })();
  </script>

  <script>
    // ----- Theme toggle -----
    const root=document.documentElement; const themeBtn=document.getElementById('themeBtn');
    const saved=localStorage.getItem('theme'); if(saved){ root.setAttribute('data-theme', saved); themeBtn.textContent = saved==='light'?'‚òÄÔ∏è Light':'üåô Dark'; }
    themeBtn.addEventListener('click',()=>{ const cur=root.getAttribute('data-theme')||'dark'; const next=cur==='dark'?'light':'dark'; root.setAttribute('data-theme',next); localStorage.setItem('theme',next); themeBtn.textContent = next==='light'?'‚òÄÔ∏è Light':'üåô Dark'; });

    // ----- Basic helpers -----
    document.getElementById('y').textContent=new Date().getFullYear();
    function setQRStatus(msg, ok){var el=document.getElementById('qrStatus'); el.textContent=msg||''; if(ok===true)el.className='ok'; else if(ok===false)el.className='err'; else el.className='muted';}
    function clearQR(){const c=document.getElementById('qrCanvas'); const x=c.getContext('2d'); x.clearRect(0,0,c.width,c.height);}    
    function ibanIsValid(iban){return /^[A-Z]{2}\d{2}[A-Z0-9]{1,30}$/.test((iban||'').replace(/\s+/g,''));}
    function buildEPC({name,iban,bic,amount,purpose}){return ['BCD','001','1','SCT',bic||'',name||'',(iban||'').replace(/\s+/g,''),amount?`EUR${Number(amount).toFixed(2)}`:'','',purpose||''].join('\n');}

    // ----- Items model & totals -----
    const bodyEl=document.getElementById('itemsBody'); const vatEl=document.getElementById('vatRate'); const amountEl=document.getElementById('amount'); const autoAmountEl=document.getElementById('autoAmount');

    function fmt(n){return (isFinite(n)?n:0).toFixed(2).replace('.',',')+' \u20AC';}
    function parseNum(v){const n=parseFloat(String(v).replace(',','.')); return isFinite(n)?n:0;}

    function addItem(data={desc:'', qty:1, price:0}){
      const i=bodyEl.children.length+1;
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td><input aria-label="Pos" value="${i}" style="width:48px" disabled></td>
        <td><input aria-label="Beschreibung" value="${data.desc||''}"></td>
        <td><input aria-label="Menge" type="number" min="0" step="0.01" value="${data.qty||1}"></td>
        <td><input aria-label="Preis" type="number" min="0" step="0.01" value="${data.price||0}"></td>
        <td class="t-right subtotal">0,00 ‚Ç¨</td>
        <td class="t-right"><button class="btn" title="Entfernen">‚úï</button></td>`;
      bodyEl.appendChild(tr);
      tr.addEventListener('input', computeTotals);
      tr.querySelector('button').addEventListener('click', ()=>{ tr.remove(); renumber(); computeTotals(); });
      computeTotals();
    }

    function renumber(){[...bodyEl.children].forEach((tr,idx)=>{ tr.querySelector('td:first-child input').value = idx+1; });}

    function getItems(){
      return [...bodyEl.children].map(tr=>{
        const [pos,desc,qty,price] = tr.querySelectorAll('input');
        return { desc: desc.value.trim(), qty: parseNum(qty.value), price: parseNum(price.value) };
      });
    }

    function computeTotals(){
      const items=getItems(); let net=0;
      [...bodyEl.children].forEach((tr,idx)=>{
        const it=items[idx]; const sub=it.qty*it.price; net+=sub; tr.querySelector('.subtotal').textContent=fmt(sub);
      });
      const vatRate=parseNum(vatEl.value); const vatAmt=+(net*vatRate/100); const gross=net+vatAmt;
      document.getElementById('sumNet').textContent=fmt(net);
      document.getElementById('sumVat').textContent=fmt(vatAmt);
      document.getElementById('sumGross').textContent=fmt(gross);
      if(autoAmountEl.checked){ amountEl.value = gross.toFixed(2); }
    }

    // Start with two demo rows
    addItem({desc:'Dienstleistung A', qty:1, price:100});
    addItem({desc:'Dienstleistung B', qty:1, price:50});
    vatEl.addEventListener('input', computeTotals);

    // ----- QR generation -----
    async function drawQRToCanvas(epc){
      const canvas=document.getElementById('qrCanvas'); const ctx=canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width,canvas.height);
      if(window.QRCode && typeof window.QRCode.toCanvas==='function'){ await window.QRCode.toCanvas(canvas, epc, {errorCorrectionLevel:'M', margin:2, width:220}); return; }
      if(window.QRCode && window.QRCode.CorrectLevel){ const tmp=document.createElement('div'); document.body.appendChild(tmp); new window.QRCode(tmp,{text:epc,width:220,height:220,correctLevel:window.QRCode.CorrectLevel.M}); await new Promise(r=>setTimeout(r,0)); const el=tmp.querySelector('canvas, img'); if(el){ if(el.tagName==='CANVAS') ctx.drawImage(el,0,0,220,220); else { await new Promise((res,rej)=>{el.onload=res; el.onerror=rej;}); ctx.drawImage(el,0,0,220,220);} } tmp.remove(); return; }
      if(typeof window.qrcode==='function'){ const qr=window.qrcode(0,'M'); qr.addData(epc); qr.make(); const html=qr.createImgTag(4,0); const src=(html.match(/src=\"([^\"]+)\"/)||[])[1]; const img=new Image(); img.src=src; await new Promise((res,rej)=>{img.onload=res; img.onerror=rej;}); ctx.drawImage(img,0,0,220,220); return; }
      throw new Error('Keine kompatible QR‚ÄëBibliothek gefunden.');
    }

    async function makeQR(){
      const name=document.getElementById('name').value; const iban=document.getElementById('iban').value; const bic=document.getElementById('bic').value; const amount=document.getElementById('amount').value; const purpose=document.getElementById('purpose').value;
      const ok=ibanIsValid(iban); if(!ok){ setQRStatus('IBAN ung√ºltig ‚Äì bitte pr√ºfen.', false); clearQR(); return; }
      try{ await (window.__libsReady||Promise.resolve()); const epc=buildEPC({name,iban,bic,amount,purpose}); await drawQRToCanvas(epc); setQRStatus('QR erfolgreich generiert.', true);} catch(e){ console.error(e); setQRStatus(e.message||'Unbekannter Fehler bei der QR‚ÄëGenerierung.', false);} }

// ===== NEUES PDF-LAYOUT ‚Äì gro√üz√ºgige Abst√§nde & klare Sektionen =====
async function downloadPDF(){
  try{
    if(typeof PDFLib==='undefined'){ alert('PDF-Bibliothek nicht geladen.'); return; }
    const { PDFDocument, StandardFonts, rgb } = PDFLib;
    const pdfDoc = await PDFDocument.create();
    const size = { w: 595.28, h: 841.89 }; // A4
    let page = pdfDoc.addPage([size.w, size.h]);
    const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
    const bold = await pdfDoc.embedFont(StandardFonts.HelveticaBold);

    const M = 50; // Seitenrand
    let y = size.h - M;

    const drawLeft = (text, x, y, s=11, f=font, c=rgb(0,0,0)) =>
      page.drawText(String(text||''), { x, y, size:s, font:f, color:c });

    const drawRight = (text, x, y, s=11, f=font, c=rgb(0,0,0)) => {
      const t = String(text||''); const w = f.widthOfTextAtSize(t, s);
      page.drawText(t, { x: x - w, y, size:s, font:f, color:c });
    };

    const line = (x1, y1, x2, y2, c=rgb(0.85,0.88,0.95)) =>
      page.drawLine({ start:{x:x1,y:y1}, end:{x:x2,y:y2}, thickness:1, color:c });

    const wrap = (text, width, s=11, f=font) => {
      const words = String(text||'').split(/\s+/); let out=[], cur='';
      for (const w of words){
        const test = cur ? cur+' '+w : w;
        if (f.widthOfTextAtSize(test, s) > width){ if(cur) out.push(cur); cur = w; }
        else cur = test;
      }
      if(cur) out.push(cur);
      return out;
    };

    const addPageIfNeeded = (need=60) => {
      if (y - need < M + 60) {
        page = pdfDoc.addPage([size.w, size.h]);
        y = size.h - M;
        // Tabellenkopf neu zeichnen
        drawLeft('Beschreibung', M, y, 10, bold, rgb(0.35,0.4,0.55));
        drawRight('Betrag (‚Ç¨)', size.w - M, y, 10, bold, rgb(0.35,0.4,0.55));
        y -= 10; line(M, y, size.w - M, y); y -= 12;
      }
    };

    // Header
    drawLeft('Rechnung', M, y, 24, bold);
    drawRight(new Date().toISOString().slice(0,10), size.w - M, y, 10, font, rgb(0.35,0.4,0.55));

    // QR oben rechts (falls vorhanden)
    try{
      const canvas = document.getElementById('qrCanvas');
      if(canvas){
        const dataUrl = canvas.toDataURL('image/png');
        if(dataUrl && dataUrl.length > 100){
          const bytes = await fetch(dataUrl).then(r=>r.arrayBuffer());
          const img = await pdfDoc.embedPng(bytes);
          const q = 120;
          page.drawImage(img, { x: size.w - M - q, y: size.h - M - q, width: q, height: q });
        }
      }
    }catch(_){} // QR optional
    y -= 28;

    // Zahlungsdaten
    drawLeft('Zahlungsdaten', M, y, 11, bold, rgb(0.35,0.4,0.55)); y -= 14;
    const kv = [
      ['Empf√§nger', document.getElementById('name').value || '‚Äî'],
      ['IBAN', document.getElementById('iban').value || '‚Äî'],
      ['BIC', document.getElementById('bic').value || '‚Äî'],
      ['Verwendungszweck', document.getElementById('purpose').value || '‚Äî'],
    ];
    const labelW = 110;
    for (const [k,v] of kv){
      drawLeft(k+':', M, y, 11, font, rgb(0.45,0.5,0.65));
      drawLeft(v, M + labelW, y, 11, font);
      y -= 14;
    }

    y -= 6; line(M, y, size.w - M, y); y -= 18;

    // Positionen ‚Äì Kopf
    const col = { pos: M, desc: M + 24, amt: size.w - M };
    drawLeft('Pos', col.pos, y, 10, bold, rgb(0.35,0.4,0.55));
    drawLeft('Beschreibung', col.desc, y, 10, bold, rgb(0.35,0.4,0.55));
    drawRight('Betrag (‚Ç¨)', col.amt, y, 10, bold, rgb(0.35,0.4,0.55));
    y -= 10; line(M, y, size.w - M, y); y -= 12;

    // Positionen ‚Äì Zeilen
    const rows = document.querySelectorAll('#positions tbody tr');
    let idx = 1; let sum = 0;
    rows.forEach(tr=>{
      const desc = tr.querySelector('.desc')?.value || '';
      const amt = parseFloat(tr.querySelector('.amt')?.value) || 0;
      sum += amt;
      const lines = wrap(desc, col.amt - col.desc - 40);
      const rowH = Math.max(lines.length * 12, 14);
      addPageIfNeeded(rowH + 12);
      drawLeft(String(idx), col.pos, y, 11, font);
      lines.forEach((ln,i)=> drawLeft(ln, col.desc, y - i*12, 11, font));
      drawRight(amt.toFixed(2), col.amt, y, 11, font);
      y -= rowH + 8; idx++;
    });

    y -= 6; line(M, y, size.w - M, y); y -= 12;

    // Summe ‚Äì Box rechts
    const boxW = 220, boxH = 56;
    addPageIfNeeded(boxH + 20);
    page.drawRectangle({ x: size.w - M - boxW, y: y - boxH + 4, width: boxW, height: boxH, borderWidth: 1, color: rgb(0.85,0.88,0.95) });
    drawLeft('Gesamt (brutto):', size.w - M - boxW + 12, y + 20, 11, bold);
    drawRight((document.getElementById('sum').textContent||'0.00') + ' ‚Ç¨', size.w - M - 12, y + 20, 14, bold);
    y -= boxH + 10;

    // Footer
    drawLeft('Hinweis: Diese Rechnung wurde lokal im Browser generiert.', M, M, 9, font, rgb(0.45,0.5,0.65));

    // Download
    const pdfBytes = await pdfDoc.save();
    const blob = new Blob([pdfBytes], { type: 'application/pdf' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'rechnung.pdf';
    link.click();
    setTimeout(()=>URL.revokeObjectURL(link.href), 5000);
  }catch(e){ console.error(e); alert('PDF-Fehler: '+(e.message||e)); }
}
</script>
</body>
</html>
